#!/bin/bash
# 実際のコードレビューテスト

echo "======================================================================"
echo "  実際のコードレビューテスト"
echo "======================================================================"
echo ""

SAMPLE_FILE="sample_code_to_review.py"
PROMPT_FILE="/tmp/review_prompt.txt"
OUTPUT_FILE="review_result.txt"

# プロンプトの作成
cat > "$PROMPT_FILE" << 'EOF'
以下のPythonコードをレビューして、改善してください：

要件：
1. PEP8準拠に修正
2. 型ヒントを追加
3. ドキュメント文字列を追加
4. エラーハンドリングを追加
5. 変数名をより明確に

コード：
EOF

cat "$SAMPLE_FILE" >> "$PROMPT_FILE"

echo "✅ レビュープロンプトを作成しました"
echo "📄 プロンプト: $PROMPT_FILE"
echo ""

# オプション1: 対話型で開く（推奨）
echo "======================================================================"
echo "オプション1: 対話型Copilot CLI（推奨）"
echo "======================================================================"
echo "以下のコマンドを実行してください："
echo ""
echo "  copilot"
echo ""
echo "そして以下のプロンプトを貼り付けてください："
echo "----------------------------------------------------------------------"
cat "$PROMPT_FILE"
echo "----------------------------------------------------------------------"
echo ""

# オプション2: 非対話モード（実験的）
echo "======================================================================"
echo "オプション2: 非対話モード（実験的）"
echo "======================================================================"
echo "⚠️  認証が必要な場合は、先に 'copilot' を起動して /login してください"
echo ""

read -p "非対話モードを試しますか？ (y/N): " answer

if [[ "$answer" == "y" || "$answer" == "Y" ]]; then
    echo ""
    echo "🚀 Copilot CLIを非対話モードで実行中..."
    
    # タイムアウト付きで実行
    timeout 60s copilot -p "$(cat $PROMPT_FILE)" --allow-all-tools > "$OUTPUT_FILE" 2>&1
    
    EXIT_CODE=$?
    
    if [ $EXIT_CODE -eq 0 ]; then
        echo "✅ レビュー完了"
        echo "📄 結果: $OUTPUT_FILE"
        echo ""
        echo "結果の内容："
        echo "======================================================================"
        cat "$OUTPUT_FILE"
        echo "======================================================================"
    elif [ $EXIT_CODE -eq 124 ]; then
        echo "⏱️  タイムアウト（60秒）"
        echo "対話モードでの使用をお勧めします"
    else
        echo "❌ エラーが発生しました（終了コード: $EXIT_CODE）"
        echo "出力："
        cat "$OUTPUT_FILE"
    fi
else
    echo "スキップしました"
fi

echo ""
echo "======================================================================"
echo "  完了"
echo "======================================================================"
echo ""
echo "💡 ヒント："
echo "  - 最も確実なのは対話型モード: copilot"
echo "  - プロンプトは $PROMPT_FILE に保存されています"
echo "  - VS Codeで直接開くことも可能: code $SAMPLE_FILE"
echo ""
